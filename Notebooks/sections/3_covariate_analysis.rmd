# t-test of observations using one hot encoded data

```{r}
robust_se <- function(model){
  # get robust standard error
  sqrt(diag(vcovHC(model)))
}

d <- fread(file="../data/fb_ad_data.csv")
```

```{r one-hot encode treatment groups}
ad_codes <- c('control', 'visual_', 'text_', 'text_visual')
ad_groups <- c('control', 'visual treatment', 'text treatment', 'text + visual treatment')
for (i in 1:length(ad_groups)) {
  d[, ad_codes[i] := ifelse(group == ad_groups[i], 1, 0)]
}
```

```{r one-hot encode genders}
genders <- c('female', 'male')
for (i in 1:length(genders)) {
  d[, genders[i] := ifelse(gender == genders[i], 1, 0)]
}
d[, "unknown_gender" := ifelse(gender == "unknown", 1, 0)]
```

```{r one-hot encode ages}
age_codes <- c('a18_24', 'a25_34', 'a35_44', 'a45_54', 'a55_64', 'a65plus')
ages <- c('18-24', '25-34', '35-44', '45-54', '55-64', '65+')
for (i in 1:length(ages)) {
  d[, age_codes[i] := ifelse(age == ages[i], 1, 0)]
}
d[, "unknown_age" := ifelse(age == "unknown", 1, 0)]
```

```{r t-test of total observations}
#Estimate model
m1 <- lm(control + text_ + visual_ ~ female + a18_24 + a25_34 + a35_44 + a45_54 + a55_64 + a65plus, data=d)
#Print results
stargazer(m1, 
          se = list(robust_se(m1)),
          type = 'text')
```

# Randomization check
```{r}
# Randomize a set of data, compute mean difference, record % exceeding observed mean
#
# filename is the name of the file containing the data - one column of data w/ header
# n1 and n2 are the sample sizes for the two independent sets of data
# iterations is the number of times to loop through the process -- I usually use 10000
resample.u.between <- function(n1,n2,iterations) {
  #Read in data and initialize variables
  names(score)[1] <- 'var1'
  nsample <- length(score$var1)
  startn2 <- n1+1
  target <- abs(mean(score$var1[1:n1]) - mean(score$var1[startn2:nsample]))
  y <- 1
  ucomp <- vector()
  uarray <- vector()
  #Loop starts here
  while (y <= iterations) {
    #Randomize the sample
    perm <- sample(score$var1,replace=F)
    #cat(perm,"\n")
    #Get the two samples and compute the absolute difference in means
    mean.first <- mean(perm[1:n1])
    mean.second <- mean(perm[startn2:nsample])
    mean.diff <- abs(mean.first - mean.second)
    #Compare mean.diff to target and store in ucomp array
    if (mean.diff >= target) {
    ucomp [y] <- 1
    } else {
    ucomp [y] <- 0 }
  y <- y+1 
  }
  #Loop ends above here
  #Compute mean of ucomp which is proportion of u >= target
  uexceed <- mean(ucomp)
  #cat(uarray,"\n")
  #cat(ucomp,"\n")
  cat("Observed mean difference: ",target,"\n")
  cat("Proportion exceeding observed mean difference: ",uexceed)
}
resample.u.between('sampletimes.txt',11,9,10000)

#For testing:
filename <- 'NPS_GTM_WebEx.txt'
n1 <- 36
n2 <- 31
iterations <- 10000
```

# Covariate Balance Check
Each covariate appears balanced across the four groups.

```{r covariate balance check}
#Balance check: Averages across control and treatment groups
cov_balance_checks <- d[, mean(clicked) * 100, by=.(group)]

#Balance check: Share of females across control and treatment groups
cov_balance_checks$share_female <- d[, sum(gender == 'female')/(.N), by=.(group)]$V1

#Balance check: Share of males across control and treatment groups
cov_balance_checks$share_male <- d[, sum(gender == 'male')/(.N), by=.(group)]$V1

#Balance check: Share of 18-24 year olds across control and treatment groups
cov_balance_checks$share_18_24 <- d[, sum(age == '18-24')/(.N), by=.(group)]$V1

#Balance check: Share of 25-34 year olds across control and treatment groups
cov_balance_checks$share_25_34 <- d[, sum(age == '25-34')/(.N), by=.(group)]$V1

#Balance check: Share of 35-44 year olds across control and treatment groups
cov_balance_checks$share_35_44 <- d[, sum(age == '35-44')/(.N), by=.(group)]$V1

#Balance check: Share of 45-54 year olds across control and treatment groups
cov_balance_checks$share_45_54 <- d[, sum(age == '45-54')/(.N), by=.(group)]$V1

#Balance check: Share of 55-64 year olds across control and treatment groups
cov_balance_checks$share_55_64 <- d[, sum(age == '55-64')/(.N), by=.(group)]$V1

#Balance check: Share of 65+ year olds across control and treatment groups
cov_balance_checks$share_65 <- d[, sum(age == '65+')/(.N), by=.(group)]$V1

#Balance check: Share of "unknown age" not necessary -- can subtract. 
head(cov_balance_checks)

```

# Covariate Balance Check Against Pilot Study
Mean clicks should look similar across groups for pilot study and full study. Covariates should also look similar.

```{r compare to pilot}
#Read in pilot data
pilot <- fread(file="../data/pilot_data.csv")
setnames(pilot, "Ad name", "group")
setnames(pilot, "Unique clicks (all)", "clicked")

#Balance check: Averages across control and treatment groups for pilot
pilot_balance_checks <- pilot[, 100*sum(clicked)/sum(Reach), by=.(group)]

#Balance check: Share of females across control and treatment groups for pilot
pilot_balance_checks$share_female <- pilot[Gender == 'female', sum(clicked), by=.(group)]$V1/pilot[, sum(clicked), by=.(group)]$V1

pilot_balance_checks
```